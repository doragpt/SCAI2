### **ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘å…·ä½“çš„ãªæŒ‡ç¤ºæ›¸ï¼ˆäºˆç´„æŠ•ç¨¿æ©Ÿèƒ½ã®å®Ÿè£…ï¼‰**

---

## **ğŸ“Œ ç›®çš„**
ç¾åœ¨ã® `blog_posts` ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ `blogPostSchema` ã«ã¯ `scheduledAt` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã€äºˆç´„æŠ•ç¨¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€äºˆç´„æŠ•ç¨¿ãŒè‡ªå‹•ã§å…¬é–‹ã•ã‚Œã‚‹ä»•çµ„ã¿ãŒæœªå®Ÿè£…ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿæ–½ã—ã€äºˆç´„æŠ•ç¨¿æ©Ÿèƒ½ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚

---

## **ğŸ›  å®Ÿè£…ã‚¿ã‚¹ã‚¯**
### **1ï¸âƒ£ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£ï¼ˆReactï¼‰**
#### **ğŸ“Œ ã‚¿ã‚¹ã‚¯**
1. `scheduledAt` ã®å€¤ã‚’ **ISO 8601ï¼ˆUTCï¼‰** ã«å¤‰æ›ã—ã¦ API ã«é€ä¿¡ã™ã‚‹ã€‚
2. äºˆç´„æ—¥æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã€éå»ã®æ—¥æ™‚ã‚’é¸æŠã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã€‚

#### **âœ… ä¿®æ­£ã‚³ãƒ¼ãƒ‰**
#### **(1) `handleSubmit` ã®ä¿®æ­£**
```tsx
const handleSubmit = async (data: any, status: "draft" | "published" | "scheduled") => {
  try {
    let scheduledAt = null;
    if (status === "scheduled") {
      if (!scheduledDateTime || new Date(scheduledDateTime) <= new Date()) {
        toast({
          variant: "destructive",
          title: "ã‚¨ãƒ©ãƒ¼",
          description: "æœªæ¥ã®æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„",
        });
        return;
      }
      scheduledAt = new Date(scheduledDateTime).toISOString(); // ISOå½¢å¼ï¼ˆUTCï¼‰
    }

    const formData = {
      title: data.title,
      content: data.content,
      status: status,
      thumbnail: data.thumbnail,
      scheduledAt: scheduledAt,
      storeId: user?.userId
    };

    if (postId) {
      await updateMutation.mutateAsync(formData);
    } else {
      await createMutation.mutateAsync(formData);
    }
  } catch (error) {
    toast({ variant: "destructive", title: "ã‚¨ãƒ©ãƒ¼", description: "ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ" });
  }
};
```
#### **(2) `datetime-local` ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**
```tsx
<Input
  type="datetime-local"
  value={scheduledDateTime}
  onChange={(e) => setScheduledDateTime(e.target.value)}
  min={new Date().toISOString().slice(0, 16)} // éå»ã®æ—¥æ™‚ã‚’ç„¡åŠ¹åŒ–
/>
```
---
### **2ï¸âƒ£ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¿®æ­£ï¼ˆExpress + Drizzle ORMï¼‰**
#### **ğŸ“Œ ã‚¿ã‚¹ã‚¯**
1. `POST /api/blog/posts` ã« `scheduledAt` ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã€‚
2. å®šæœŸçš„ã« `scheduledAt` ãŒéå»ã®ã‚‚ã®ã‚’ `published` ã«æ›´æ–°ã™ã‚‹ãƒãƒƒãƒå‡¦ç†ã‚’è¿½åŠ ã€‚

#### **âœ… ä¿®æ­£ã‚³ãƒ¼ãƒ‰**
#### **(1) `POST /api/blog/posts` ã®ä¿®æ­£**
```ts
app.post("/api/blog/posts", async (req, res) => {
  const { title, content, status, scheduledAt, storeId, thumbnail, images } = req.body;

  if (status === "scheduled" && !scheduledAt) {
    return res.status(400).json({ error: "äºˆç´„æŠ•ç¨¿ã«ã¯å…¬é–‹äºˆå®šæ—¥æ™‚ãŒå¿…è¦ã§ã™" });
  }

  const result = await db.insert(blogPosts).values({
    title,
    content,
    status,
    scheduledAt: scheduledAt ? new Date(scheduledAt) : null, // UTCå½¢å¼ã§ä¿å­˜
    storeId,
    thumbnail,
    images,
    createdAt: new Date(),
  }).returning();

  res.json(result);
});
```
#### **(2) `PUT /api/blog/posts/:id` ã®ä¿®æ­£**
```ts
app.put("/api/blog/posts/:id", async (req, res) => {
  const { title, content, status, scheduledAt, thumbnail, images } = req.body;
  const { id } = req.params;

  if (status === "scheduled" && !scheduledAt) {
    return res.status(400).json({ error: "äºˆç´„æŠ•ç¨¿ã«ã¯å…¬é–‹äºˆå®šæ—¥æ™‚ãŒå¿…è¦ã§ã™" });
  }

  const result = await db.update(blogPosts)
    .set({
      title,
      content,
      status,
      scheduledAt: scheduledAt ? new Date(scheduledAt) : null,
      thumbnail,
      images,
      updatedAt: new Date(),
    })
    .where({ id });

  res.json(result);
});
```
---
### **3ï¸âƒ£ äºˆç´„æŠ•ç¨¿ã®è‡ªå‹•å…¬é–‹ãƒãƒƒãƒå‡¦ç†**
#### **ğŸ“Œ ã‚¿ã‚¹ã‚¯**
1. `scheduledAt` ã®æ™‚é–“ãŒç¾åœ¨æ™‚åˆ»ã‚’è¶…ãˆãŸè¨˜äº‹ã‚’è‡ªå‹•ã§ `published` ã«ã™ã‚‹ã€‚
2. å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒãƒƒãƒå‡¦ç†ã‚’è¿½åŠ ï¼ˆ`setInterval` or `cron`ï¼‰ã€‚

#### **âœ… ä¿®æ­£ã‚³ãƒ¼ãƒ‰**
```ts
import { db } from "@/lib/db";

async function publishScheduledPosts() {
  const now = new Date();
  try {
    const postsToPublish = await db.query.blogPosts.findMany({
      where: {
        status: "scheduled",
        scheduledAt: { lte: now }, // ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå‰ã®äºˆç´„æŠ•ç¨¿ã‚’å–å¾—
      },
    });

    for (const post of postsToPublish) {
      await db.update(blogPosts)
        .set({ status: "published", publishedAt: now })
        .where({ id: post.id });
      console.log(`Published post: ${post.id}`);
    }
  } catch (error) {
    console.error("Error publishing scheduled posts:", error);
  }
}

// 15åˆ†ã”ã¨ã«äºˆç´„æŠ•ç¨¿ã‚’ãƒã‚§ãƒƒã‚¯
setInterval(publishScheduledPosts, 15 * 60 * 1000);
```
---
### **4ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª**
#### **ğŸ“Œ ã‚¿ã‚¹ã‚¯**
1. `blog_posts` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `scheduledAt` ã‚’ `TIMESTAMP WITH TIME ZONE` ã«å¤‰æ›´ã€‚
2. `scheduledAt` ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã€æ¤œç´¢ã‚’é«˜é€ŸåŒ–ã€‚

#### **âœ… ä¿®æ­£ã‚³ãƒ¼ãƒ‰**
```ts
export const blogPosts = pgTable("blog_posts", {
  id: serial("id").primaryKey(),
  storeId: integer("store_id").notNull().references(() => users.id),
  title: text("title").notNull(),
  content: text("content").notNull(),
  status: text("status", { enum: ["draft", "published", "scheduled"] }).notNull().default("draft"),
  publishedAt: timestamp("published_at"),
  scheduledAt: timestamp("scheduled_at").notNull(),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
  thumbnail: text("thumbnail"),
  images: jsonb("images").$type<string[]>().default([]),
}, (table) => {
  return {
    storeIdIdx: index("blog_posts_store_id_idx").on(table.storeId),
    statusIdx: index("blog_posts_status_idx").on(table.status),
    publishedAtIdx: index("blog_posts_published_at_idx").on(table.publishedAt),
    scheduledAtIdx: index("blog_posts_scheduled_at_idx").on(table.scheduledAt), // è¿½åŠ 
  };
});
```
---
## **ğŸ“Œ æœŸå¾…ã™ã‚‹å‹•ä½œ**
1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
   - è¨˜äº‹ä½œæˆæ™‚ã«ã€Œäºˆç´„æŠ•ç¨¿ã€ã‚’é¸æŠã—ã€æ—¥æ™‚ã‚’æŒ‡å®šã§ãã‚‹ã€‚
   - éå»ã®æ—¥æ™‚ã¯é¸æŠã§ããªã„ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã€‚
   - äºˆç´„æŠ•ç¨¿ãŒæ­£ã—ã API ã«é€ä¿¡ã•ã‚Œã‚‹ã€‚

2. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**
   - äºˆç´„æŠ•ç¨¿ã®ãƒ‡ãƒ¼ã‚¿ãŒ `scheduledAt` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚
   - `status === "scheduled"` ã®è¨˜äº‹ãŒã€`scheduledAt` ã‚’è¶…ãˆãŸã‚‰ `published` ã«è‡ªå‹•å¤‰æ›´ã•ã‚Œã‚‹ã€‚

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**
   - `scheduledAt` ã«é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¿½åŠ ã•ã‚Œã€æ¤œç´¢ãŒé«˜é€ŸåŒ–ã•ã‚Œã‚‹ã€‚
   - äºˆç´„æŠ•ç¨¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã‚‹ã€‚

---
## **ğŸ“ ã¾ã¨ã‚**
âœ… **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
- `scheduledAt` ã®æ—¥æ™‚å¤‰æ› (`toISOString()`)
- æœªæ¥ã®æ—¥æ™‚ã®ã¿é¸æŠå¯èƒ½ã«ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

âœ… **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**
- `POST` / `PUT` API ã§ `scheduledAt` ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
- `scheduledAt` ã‚’è¶…ãˆãŸè¨˜äº‹ã‚’ `published` ã«ã™ã‚‹ãƒãƒƒãƒå‡¦ç† (`setInterval`)

âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**
- `scheduledAt` ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ  (`scheduledAtIdx`)

---
## **ğŸ’¡ ã“ã‚Œã‚’å®Ÿè£…ã™ã‚Œã°ã€äºˆç´„æŠ•ç¨¿æ©Ÿèƒ½ãŒå®Œæˆã—ã¾ã™ï¼**
ã“ã®ã‚¿ã‚¹ã‚¯ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚è³ªå•ãŒã‚ã‚Œã°ã™ãã«é€£çµ¡ã—ã¦ãã ã•ã„ï¼ ğŸš€